<!doctype html>
<html lang="sv">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inlev – Insamlare</title><link rel="stylesheet" href="/styles.css"></head>
<body>
<div class="container">
  <div class="nav"><button id="saveAll">Spara Sändning</button><button id="openAll">Öppna Sändning</button><input type="file" id="openFile" accept="application/json" style="display:none">
    <a href="/">Hem</a><a href="/uppdatera-info.html">Uppdatera info</a><a href="/felsok.html">Felsök</a>
  </div>
  <h1>Insamlare – 3 fält</h1>
  <div class="section"><h2>Länkade rader</h2>
    <div class="fixedheaders"><span class="badge">A: Ordernummer</span><span class="badge">B: Position</span><span class="badge">C: SKU/Beskrivning</span><span class="badge">D: Beställt</span><span class="badge">E: Återstår</span><span class="badge">F: Levererat</span><span class="badge">G: Behov</span></div>
    <div class="row"><button data-action="paste" data-key="lankade">Klistra in</button><button data-action="parse" data-key="lankade">Tolka</button><span class="badge" id="rows-lankade">Rader: 0</span></div>
    <textarea id="raw-lankade"></textarea><div style="overflow:auto;max-height:40vh;border:1px solid #1e2a57;border-radius:12px"><table id="tbl-lankade" class="table"></table></div>
    <p class="small">De 4 första raderna hoppas över.</p>
  </div>
  <div class="section"><h2>Uppackning</h2>
    <div class="fixedheaders"><span class="badge">A: Ordernummer</span><span class="badge">B: Position</span><span class="badge">C: Leverantörs SKU</span><span class="badge">D: SKU</span><span class="badge">E: Beskrivning</span><span class="badge">F: Aviserad</span><span class="badge">G: Levererat</span><span class="badge">H: Återstår</span><span class="badge">I: Behov</span></div>
    <div class="row"><button data-action="paste" data-key="uppackning">Klistra in</button><button data-action="parse" data-key="uppackning">Tolka</button><span class="badge" id="rows-uppackning">Rader: 0</span></div>
    <textarea id="raw-uppackning"></textarea><div style="overflow:auto;max-height:40vh;border:1px solid #1e2a57;border-radius:12px"><table id="tbl-uppackning" class="table"></table></div>
  </div>
  <div class="section"><h2>Registrerade kollin</h2>
    <div class="fixedheaders"><span class="badge">A: Hanteringsenhet</span><span class="badge">B: Artikelbeskrivning</span><span class="badge">C: SKU</span><span class="badge">D: Batchnummer</span><span class="badge">E: Lagerzonsflöde</span><span class="badge">F: Fack</span><span class="badge">G: Antal</span></div>
    <div class="row"><button data-action="paste" data-key="registrerade">Klistra in</button><button data-action="parse" data-key="registrerade">Tolka</button><span class="badge" id="rows-registrerade">Rader: 0</span></div>
    <textarea id="raw-registrerade"></textarea><div style="overflow:auto;max-height:40vh;border:1px solid #1e2a57;border-radius:12px"><table id="tbl-registrerade" class="table"></table></div>
  </div>
</div>
<script>
(function(){
const LINKED=['Ordernummer','Position','SKU/Beskrivning','Beställt','Återstår','Levererat','Behov'];
const UPP=['Ordernummer','Position','Leverantörs SKU','SKU','Beskrivning','Aviserad','Levererat','Återstår','Behov'];
const REG=['Hanteringsenhet','Artikelbeskrivning','SKU','Batchnummer','Lagerzonsflöde','Fack','Antal'];
const state={lankade:{headers:LINKED,rows:JSON.parse(localStorage.getItem('inlev:lankade:rows')||'[]')},uppackning:{headers:UPP,rows:JSON.parse(localStorage.getItem('inlev:uppackning:rows')||'[]')},registrerade:{headers:REG,rows:JSON.parse(localStorage.getItem('inlev:registrerade:rows')||'[]')}};
const one=v=>String(v??'').replace(/\s*\n\s*/g,' ').trim();
function parseTSV(s){s=(s||'').replace(/\r\n?/g,'\n');const rows=[];let f='',r=[],q=false;for(let i=0;i<s.length;i++){const c=s[i],n=s[i+1];if(q){if(c==='"'){if(n==='"'){f+='"';i++;}else q=false;}else f+=c;}else{if(c==='"')q=true;else if(c==='\t'){r.push(f);f='';}else if(c==='\n'){r.push(f);rows.push(r);r=[];f='';}else f+=c;}}r.push(f);rows.push(r);return rows.filter(r=>r.some(x=>String(x||'').trim()!==''));}
function lastNum(v){if(v==null)return 0;const parts=String(v).split(/\n+/).map(x=>x.trim()).filter(Boolean);const nums=parts.map(p=>Number(p.replace(',','.'))).filter(n=>!isNaN(n));if(!nums.length)return 0;const last=[...nums].reverse().find(n=>n!==0);return last ?? nums[nums.length-1];}
function smartSku(val,lev){const s=String(val||'').trim();const nl=s.split(/\s*\n\s*/).filter(Boolean);if(nl.length>=2)return{sku:nl[0].trim(),desc:nl.slice(1).join(' ').replace(/\s{2,}/g,' ').trim()};const m=s.match(/^([A-Za-z0-9\-]+)\s+(.+)$/);if(m&&/[0-9]/.test(m[1]))return{sku:m[1],desc:m[2].replace(/\s{2,}/g,' ').trim()};return{sku:String(lev||'').trim(),desc:s};}
function toLinked(rows){const out=[];for(const r of rows){const c=r.slice();while(c.length<7)c.push('');const o={'Ordernummer':one(c[0]),'Position':one(c[1]),'SKU/Beskrivning':one(c[2]),'Beställt':String(lastNum(c[3])),'Återstår':String(lastNum(c[4])),'Levererat':one(c[5]),'Behov':String(lastNum(c[6]))};if(Object.values(o).some(v=>String(v||'').trim()!==''))out.push(o);}return out;}
function toUpp(rows){const out=[];for(const r of rows){const c=r.slice();while(c.length<8)c.push('');const lev=one(c[2]);const sp=smartSku(c[3],lev);const o={'Ordernummer':one(c[0]),'Position':one(c[1]),'Leverantörs SKU':lev,'SKU':sp.sku,'Beskrivning':sp.desc,'Aviserad':String(lastNum(c[4])),'Levererat':String(lastNum(c[5])),'Återstår':String(lastNum(c[6])),'Behov':String(lastNum(c[7]))};if(Object.values(o).some(v=>String(v||'').trim()!==''))out.push(o);}return out;}
function toReg(rows){const out=[];for(const r of rows){let c=r.slice();if(c.length>REG.length)c=c.slice(0,REG.length);while(c.length<REG.length)c.push('');const o={};for(let i=0;i<REG.length;i++)o[REG[i]]=one(c[i]);if(Object.values(o).some(v=>String(v||'').trim()!==''))out.push(o);}return out;}
function render(key){const tbl=document.getElementById('tbl-'+key);tbl.innerHTML='';const hs=state[key].headers;const thead=document.createElement('thead');const trh=document.createElement('tr');hs.forEach(h=>{const th=document.createElement('th');th.textContent=h;trh.appendChild(th);});thead.appendChild(trh);tbl.appendChild(thead);const tbody=document.createElement('tbody');state[key].rows.forEach(o=>{const tr=document.createElement('tr');hs.forEach(h=>{const td=document.createElement('td');td.textContent=o[h]??'';tr.appendChild(td);});tbody.appendChild(tr);});tbl.appendChild(tbody);document.getElementById('rows-'+key).textContent='Rader: '+state[key].rows.length;}
function setRows(key,rows){state[key].rows=rows;localStorage.setItem('inlev:'+key+':rows',JSON.stringify(rows));render(key);}
document.addEventListener('click',ev=>{const b=ev.target.closest('button');if(!b)return;const a=b.getAttribute('data-action'),k=b.getAttribute('data-key');if(a&&k){if(a==='paste'){navigator.clipboard.readText().then(t=>{document.getElementById('raw-'+k).value=t;}).catch(console.warn);}if(a==='parse'){let rows=parseTSV(document.getElementById('raw-'+k).value);const skip=(k==='lankade'||k==='uppackning')?4:0;if(rows.length>skip)rows=rows.slice(skip);const objs=k==='lankade'?toLinked(rows):k==='uppackning'?toUpp(rows):toReg(rows);setRows(k,objs);}}});
['lankade','uppackning','registrerade'].forEach(k=>{try{render(k)}catch(e){}});
})();</script>

<script>
// Save/Load all inlev* localStorage keys to/from a JSON file
(function(){
  function blobDownload(name, data){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([data],{type:'application/json'}));
    a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},1000);
  }
  window.saveAllData = function(){
    const dump = {};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(/^inlev[:]/.test(k)) dump[k]=localStorage.getItem(k);
    }
    const name='inlev-sandning-'+new Date().toISOString().replace(/[:.]/g,'-')+'.json';
    blobDownload(name, JSON.stringify({version:'0.6.15', savedAt:new Date().toISOString(), data:dump}, null, 2));
  };
  window.loadAllData = function(file){
    const reader=new FileReader();
    reader.onload=()=>{
      try{
        const obj=JSON.parse(reader.result);
        const data=obj.data||obj; // accept raw dump
        let count=0;
        for(const k in data){ if(/^inlev[:]/.test(k)){ localStorage.setItem(k, data[k]); count++; } }
        alert('Laddat '+count+' nycklar. Ladda om sidan (Ctrl+R) om du inte ser uppdateringen direkt.');
      }catch(e){ alert('Fel vid läsning: '+e.message); }
    };
    reader.readAsText(file);
  };
  document.addEventListener('click', (ev)=>{
    const id=ev.target && ev.target.id;
    if(id==='saveAll') saveAllData();
    if(id==='openAll'){ document.getElementById('openFile').click(); }
  });
  document.addEventListener('change', (ev)=>{
    if(ev.target && ev.target.id==='openFile' && ev.target.files && ev.target.files[0]){
      loadAllData(ev.target.files[0]);
      ev.target.value='';
    }
  });
})();
</script>

<script>
(function(){
  function qs(n){ const u=new URL(location.href); return u.searchParams.get(n); }
  const sid = qs('sid');
  const btn = document.createElement('a');
  btn.textContent = 'Vidare till felsök';
  btn.href = sid ? ('/felsok.html?sid='+encodeURIComponent(sid)) : '/felsok.html';
  btn.style.cssText='position:fixed;right:16px;bottom:16px;background:#0f1a44;border:1px solid #1e2a57;border-radius:999px;padding:10px 14px;color:#e7eeff;text-decoration:none;font-weight:600';
  document.body.appendChild(btn);
})();
</script>
</body></html>
