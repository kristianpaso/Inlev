<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotation – Startsida</title>
  <style>
    :root{--bg:#0b1220;--text:#e9eefc;--muted:rgba(233,238,252,.72);--accent:#6aa7ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070b14, var(--bg));color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:14px}
    h1{font-size:20px;margin:0}
    .sub{font-size:12px;color:var(--muted)}
    .btn{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:800;text-decoration:none}
    .btn:hover{filter:brightness(1.06)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.09);border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px;font-size:16px}
    label{display:block;margin-top:10px;margin-bottom:6px;color:var(--muted);font-size:12px}
    input{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18)}
    .item-title{font-weight:900}
    .item-sub{font-size:12px;color:var(--muted);margin-top:4px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Rotation – Startsida</h1>
        <div class="sub">Överblick över personer och avdelningar. Öppna editor för att ändra.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
  <select id="apiMode" class="btn" style="padding:8px 10px">
    <option value="local">Localhost</option>
    <option value="render">Render</option>
  </select>
  <a class="btn" href="app.html">Öppna Editor</a>
  <button class="btn" id="refreshTop">Uppdatera</button>
</div>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Avdelningar</h2>
        <div id="deptList" class="list"></div>
      </div>

      <div class="card" style="grid-column:1/-1">
  <h2>Personer</h2>
  <div class="hint">Visar totalslit baserat på vald rotationslängd. (Totalpoäng + kcal uppskattning, 70 kg)</div>

  <label for="calcDays">Antal dagar</label>
  <input id="calcDays" type="number" min="1" max="10" step="1" value="5" />

  <div id="personList" class="list" style="margin-top:10px"></div>
</div>
    </div>
  </div>

<script>
(() => {
  const RENDER_URL = 'https://rotation-api.onrender.com';
  const LOCAL_URL = 'http://localhost:5050';

  const els = {
    apiMode: document.getElementById('apiMode'),
    refreshTop: document.getElementById('refreshTop'),
    deptList: document.getElementById('deptList'),
    personList: document.getElementById('personList'),
    calcDays: document.getElementById('calcDays')
  };

  function setApiMode(mode){
    const v = (mode === 'render') ? 'render' : 'local';
    localStorage.setItem('rotation_api_mode', v);
    if(els.apiMode) els.apiMode.value = v;
  }

  function apiBase(){
    const mode = localStorage.getItem('rotation_api_mode') || 'local';
    return mode === 'render' ? RENDER_URL : LOCAL_URL;
  }

  // defaults
  setApiMode(localStorage.getItem('rotation_api_mode') || 'local');

  async function api(path){
    const res = await fetch(apiBase() + path);
    const data = await res.json();
    if(!res.ok) throw new Error(data?.error || ('API error ' + res.status));
    return data;
  }

  function esc(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function numOrNull(v){
    if(v === null || v === undefined) return null;
    if(typeof v === 'string' && v.trim() === '') return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function estimateKgPerHour(goalPerHour, avgWeightKg){
    const g = numOrNull(goalPerHour);
    const w = numOrNull(avgWeightKg);
    if(g === null || w === null) return null;
    return g * w;
  }
  function estimateMET(kgPerHour, goalPerHour){
    if(kgPerHour === null) return null;
    let met;
    if(kgPerHour < 50) met = 2.5;
    else if(kgPerHour < 150) met = 3.5;
    else if(kgPerHour < 300) met = 4.5;
    else if(kgPerHour < 600) met = 6.0;
    else met = 7.0;
    const g = numOrNull(goalPerHour);
    if(g !== null){
      if(g >= 300) met += 0.5;
      if(g >= 600) met += 0.5;
    }
    return clamp(Math.round(met*10)/10, 2.0, 8.0);
  }
  function metToScore(met){
    if(met === null) return null;
    const minMet = 2.0, maxMet = 8.0;
    const clamped = clamp(met, minMet, maxMet);
    const t = (clamped - minMet) / (maxMet - minMet);
    return clamp(1 + Math.round(t * 9), 1, 10);
  }
  function kScore(d){
    const a = clamp(Number(d.k_timePressure ?? 0), 0, 2);
    const b = clamp(Number(d.k_interruptions ?? 0), 0, 2);
    const c = clamp(Number(d.k_complexity ?? 0), 0, 2);
    const dd = clamp(Number(d.k_errorConsequence ?? 0), 0, 3);
    const e = clamp(Number(d.k_safetyRisk ?? 0), 0, 1);
    const sum = a+b+c+dd+e;
    return clamp(sum === 0 ? 1 : sum, 1, 10);
  }
  function totalScore(metScore, k){
    if(metScore === null) return null;
    const t = (Number(metScore) + Number(k)) / 2;
    return Math.round(t*10)/10;
  }
  function kcalPerHourFromMET(met, weightKg=70){
    if(met === null) return null;
    return met * 3.5 * weightKg / 200 * 60;
  }

  async function refresh(){
    const [depts, persons] = await Promise.all([ api('/api/departments'), api('/api/persons') ]);

    // Departments
    els.deptList.innerHTML = depts.length ? '' : '<div class="hint">Inga avdelningar ännu.</div>';
    for(const d of depts){
      const goalPerHour = numOrNull(d.goalPerHour);
      const avgWeightKg = numOrNull(d.avgWeightKg);
      const kgph = estimateKgPerHour(goalPerHour, avgWeightKg);
      const met = d.met ?? estimateMET(kgph, goalPerHour);
      const metScore = d.metScore ?? metToScore(met);
      const k = d.kScore ?? kScore(d);
      const total = d.totalScore ?? totalScore(metScore, k);
      const kcalH = kcalPerHourFromMET(met, 70);
      const kcal8 = kcalH === null ? null : Math.round(kcalH * 8);

      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="item-title">${esc(d.name)}</div>
        <div class="item-sub">
          <span class="pill"><b>Total</b>: ${total ?? '—'}</span>
          <span class="pill">MET: ${metScore ?? '—'}</span>
          <span class="pill">K: ${k ?? '—'}</span>
          <span class="pill">kcal/8h: ${kcal8 ?? '—'}</span>
        </div>
      `;
      els.deptList.appendChild(div);
    }

    // Persons with rotation scoring
    const deptsById = new Map(depts.map(d => [String(d.id), d]));
    const days = clamp(Number(els.calcDays?.value || 5), 1, 10);

    function computeRotationForPerson(person){
      const deptIds = Array.isArray(person.departmentIds) ? person.departmentIds : [];
      let totalPoints = 0;
      let totalKcal = 0;
      let kcalKnown = true;
      const plan = [];

      for(let i=0;i<days;i++){
        if(deptIds.length === 0){
          plan.push({day:i+1, name:'—', total:null});
          continue;
        }
        const dept = deptsById.get(String(deptIds[i % deptIds.length]));
        if(!dept){
          plan.push({day:i+1, name:'Okänd', total:null});
          continue;
        }
        const goalPerHour = numOrNull(dept.goalPerHour);
        const avgWeightKg = numOrNull(dept.avgWeightKg);
        const kgph = estimateKgPerHour(goalPerHour, avgWeightKg);
        const met = dept.met ?? estimateMET(kgph, goalPerHour);
        const metScore = dept.metScore ?? metToScore(met);
        const k = dept.kScore ?? kScore(dept);
        const total = dept.totalScore ?? totalScore(metScore, k);

        plan.push({day:i+1, name:dept.name, total});
        if(total !== null && total !== undefined) totalPoints += Number(total);

        const kcalH = kcalPerHourFromMET(met, 70);
        if(kcalH !== null) totalKcal += kcalH * 8; else kcalKnown = false;
      }

      return {
        totalPoints: Math.round(totalPoints*10)/10,
        totalKcal: kcalKnown ? Math.round(totalKcal) : null,
        plan
      };
    }

    const rows = persons.map(p => {
      const deptNames = (p.departmentIds||[]).map(id => deptsById.get(String(id))?.name).filter(Boolean);
      const r = computeRotationForPerson(p);
      return { p, deptNames, ...r };
    });

    rows.sort((a,b) => (b.totalPoints - a.totalPoints) || ((b.totalKcal||0)-(a.totalKcal||0)));

    els.personList.innerHTML = persons.length ? '' : '<div class="hint">Inga personer ännu.</div>';
    for(const row of rows){
      const planTxt = row.plan.map(x => `${x.day}:${x.name}`).join(' • ');
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="item-title">${esc(row.p.name)}</div>
        <div class="item-sub">
          Avdelningar: ${row.deptNames.length ? esc(row.deptNames.join(', ')) : '—'}
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="pill"><b>Totalpoäng:</b> ${row.totalPoints}</span>
            <span class="pill">kcal (${days} d): ${row.totalKcal ?? '—'}</span>
          </div>
          <div class="hint" style="margin-top:6px">${esc(planTxt)}</div>
        </div>
      `;
      els.personList.appendChild(div);
    }
  }

  // events
  if(els.apiMode){
    els.apiMode.addEventListener('change', () => {
      setApiMode(els.apiMode.value);
      refresh().catch(err => alert(err.message));
    });
  }
  if(els.refreshTop) els.refreshTop.addEventListener('click', () => refresh().catch(err => alert(err.message)));
  if(els.calcDays){
    els.calcDays.addEventListener('input', () => refresh().catch(()=>{}));
    els.calcDays.addEventListener('change', () => refresh().catch(()=>{}));
  }

  refresh().catch(err => alert(err.message));
})();
</script>
</body>
</html>
