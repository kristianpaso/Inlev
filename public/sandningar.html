<!doctype html>
<html lang="sv"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sändning – lista</title>
<link rel="stylesheet" href="/styles.css">
</head><body>
<div class="container">
  <div class="nav"></div>
  <h1>Sändning</h1>
  <div class="section">
    <h2>Skapa Sändning</h2>
    <form id="createForm" class="row" onsubmit="return false;">
      <label>Sändningsnummer: <input type="text" id="snummer" required placeholder="t.ex. 500313-1" style="padding:6px 10px;border-radius:8px;border:1px solid #1e2a57;background:#0c1230;color:#e9f0ff"></label>
      <label>Starttid: <input type="text" id="starttid" readonly style="padding:6px 10px;border-radius:8px;border:1px solid #1e2a57;background:#0c1230;color:#e9f0ff"></label>
      <button id="createBtn">Skapa</button>
    </form>
    <div class="small" id="createMsg"></div>
</div>

<script>
function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
function currentSid(){ return qs('sid'); }
function lsPrefix(scope){ const sid=currentSid(); return sid ? `inlev:ship:${sid}:${scope}:` : `inlev:${scope}:`; }
function navTo(path){
  const sid=currentSid();
  if(sid){
    const u=new URL(path, location.origin); u.searchParams.set('sid', sid);
    location.href = u.pathname + u.search;
  }else{ location.href = path; }
}
function renderTopNav(showWorkflowButtons){
  const nav=document.querySelector('.nav'); if(!nav) return;
  nav.innerHTML = `
    <a href="/" data-link="home">Startsidan</a>
    <a href="/sandningar.html" data-link="list">Sändning</a>
    <span class="spacer"></span>
  `;
  if(showWorkflowButtons){
    const sid=currentSid();
    if(sid){
      const span=document.createElement('span');
      span.innerHTML = `
        <a href="/overblick.html?sid=${encodeURIComponent(sid)}">Överblick</a>
        <a href="/insamlare.html?sid=${encodeURIComponent(sid)}">Insamlare</a>
        <a href="/felsok.html?sid=${encodeURIComponent(sid)}">Felsök</a>
        <a href="/uppdatera-info.html?sid=${encodeURIComponent(sid)}">Uppdatera info</a>
      `;
      nav.insertBefore(span, nav.querySelector('.spacer'));
    }
  }
}
</script>
<div class="section">
    <h2>Överblick alla sändningar</h2>
    <table class="table" id="listTbl"></table>
  </div>
</div>

<script>
function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
function currentSid(){ return qs('sid'); }
function lsPrefix(scope){ const sid=currentSid(); return sid ? `inlev:ship:${sid}:${scope}:` : `inlev:${scope}:`; }
function navTo(path){
  const sid=currentSid();
  if(sid){
    const u=new URL(path, location.origin); u.searchParams.set('sid', sid);
    location.href = u.pathname + u.search;
  }else{ location.href = path; }
}
function renderTopNav(showWorkflowButtons){
  const nav=document.querySelector('.nav'); if(!nav) return;
  nav.innerHTML = `
    <a href="/" data-link="home">Startsidan</a>
    <a href="/sandningar.html" data-link="list">Sändning</a>
    <span class="spacer"></span>
  `;
  if(showWorkflowButtons){
    const sid=currentSid();
    if(sid){
      const span=document.createElement('span');
      span.innerHTML = `
        <a href="/overblick.html?sid=${encodeURIComponent(sid)}">Överblick</a>
        <a href="/insamlare.html?sid=${encodeURIComponent(sid)}">Insamlare</a>
        <a href="/felsok.html?sid=${encodeURIComponent(sid)}">Felsök</a>
        <a href="/uppdatera-info.html?sid=${encodeURIComponent(sid)}">Uppdatera info</a>
      `;
      nav.insertBefore(span, nav.querySelector('.spacer'));
    }
  }
}
</script>
<script>
function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
function currentSid(){ return qs('sid'); }
function lsPrefix(scope){ const sid=currentSid(); return sid ? `inlev:ship:${sid}:${scope}:` : `inlev:${scope}:`; }
function navTo(path){
  const sid=currentSid();
  if(sid){
    const u=new URL(path, location.origin);
    u.searchParams.set('sid', sid);
    location.href=u.pathname+u.search;
  }else{
    location.href=path;
  }
}
function renderTopNav(showWorkflowButtons){
  const nav=document.querySelector('.nav'); if(!nav) return;
  nav.innerHTML = `
    <a href="/" data-link="home">Startsidan</a>
    <a href="/sandningar.html" data-link="list">Sändning</a>
    <span class="spacer"></span>
  `;
  if(showWorkflowButtons){
    const sid=currentSid();
    if(sid){
      const span=document.createElement('span');
      span.innerHTML = `
        <a href="/overblick.html?sid=${encodeURIComponent(sid)}">Överblick</a>
        <a href="/insamlare.html?sid=${encodeURIComponent(sid)}">Insamlare</a>
        <a href="/felsok.html?sid=${encodeURIComponent(sid)}">Felsök</a>
        <a href="/uppdatera-info.html?sid=${encodeURIComponent(sid)}">Uppdatera info</a>
      `;
      nav.insertBefore(span, nav.querySelector('.spacer'));
    }
  }
}
</script>

<script>
renderTopNav(false);

function nowIso(){return new Date().toISOString();}
function getList(){ try{ return JSON.parse(localStorage.getItem('inlev:ship:list')||'[]'); }catch(e){ return []; } }
function setList(arr){ localStorage.setItem('inlev:ship:list', JSON.stringify(arr)); }
function blobDownload(name, data){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800); }

function keysForSid(sid){ const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i)||''; if(k.startsWith('inlev:ship:'+sid+':')) keys.push(k); } return keys; }

function exportSid(sid){
  const keys=keysForSid(sid); const data={}; keys.forEach(k=>data[k]=localStorage.getItem(k));
  const name='inlev-ship-'+sid+'-'+new Date().toISOString().replace(/[:.]/g,'-')+'.json';
  blobDownload(name, JSON.stringify({sid, savedAt:new Date().toISOString(), data}, null, 2));
}
function importSid(sid, file){
  const r=new FileReader();
  r.onload=()=>{
    try{
      const ob=JSON.parse(r.result);
      const data = ob.data || ob;
      let count=0;
      for(const k in data){
        // allow importing dump with different sid by rewriting prefix to target sid
        const v = data[k];
        const rew = k.replace(/^inlev:ship:[^:]+:/, 'inlev:ship:'+sid+':');
        localStorage.setItem(rew, v); count++;
      }
      // touch list updatedAt
      const list=getList(); const item=list.find(x=>String(x.id)===String(sid));
      if(item){ item.updatedAt = nowIso(); setList(list); }
      alert('Importerade '+count+' nycklar till sändning '+sid+'.');
      renderList();
    }catch(e){ alert('Fel vid import: '+e.message); }
  };
  r.readAsText(file);
}

function renameSid(oldId, newId){
  newId=(newId||'').trim();
  if(!newId){ alert('Nytt nummer kan inte vara tomt.'); return; }
  if(oldId===newId){ return; }
  const list=getList();
  if(list.some(x=>String(x.id)===newId)){ alert('Det finns redan en sändning med detta nummer.'); return; }
  // move keyspace
  const keys=keysForSid(oldId);
  keys.forEach(k=>{
    const v=localStorage.getItem(k);
    const nk=k.replace('inlev:ship:'+oldId+':', 'inlev:ship:'+newId+':');
    localStorage.setItem(nk, v);
  });
  keys.forEach(k=>localStorage.removeItem(k));
  // update list
  const it=list.find(x=>String(x.id)===oldId);
  if(it){ it.id=newId; it.updatedAt=nowIso(); }
  setList(list);
  renderList();
  alert('Bytte namn på sändning '+oldId+' → '+newId);
}
function deleteSid(sid){
  if(!confirm('Ta bort sändning '+sid+'? Detta raderar all lokal data kopplad till den.')) return;
  const keys=keysForSid(sid);
  keys.forEach(k=>localStorage.removeItem(k));
  const list=getList().filter(x=>String(x.id)!==sid);
  setList(list);
  renderList();
}

function renderList(){
  const tbl=document.getElementById('listTbl'); tbl.innerHTML='';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  ['Sändningsnummer','Starttid','Senast uppdaterad','Åtgärder'].forEach(h=>{const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);});
  thead.appendChild(trh); tbl.appendChild(thead);
  const tbody=document.createElement('tbody'); tbl.appendChild(tbody);
  const list=getList();
  list.sort((a,b)=>String(b.updatedAt||'').localeCompare(String(a.updatedAt||'')));
  list.forEach(rec=>{
    const tr=document.createElement('tr');
    const td0=document.createElement('td'); td0.textContent=rec.id; tr.appendChild(td0);
    const td1=document.createElement('td'); td1.textContent=rec.starttid||''; tr.appendChild(td1);
    const td2=document.createElement('td'); td2.textContent=rec.updatedAt||rec.createdAt||''; tr.appendChild(td2);
    const td3=document.createElement('td');
    const openBtn=document.createElement('button'); openBtn.textContent='Öppna'; openBtn.onclick=()=>{ location.href='/overblick.html?sid='+encodeURIComponent(rec.id); };
    const renBtn=document.createElement('button'); renBtn.textContent='Byt namn'; renBtn.style.marginLeft='6px'; renBtn.onclick=()=>{ const nv=prompt('Nytt sändningsnummer:', rec.id); if(nv!=null) renameSid(rec.id, nv); };
    const expBtn=document.createElement('button'); expBtn.textContent='Exportera'; expBtn.style.marginLeft='6px'; expBtn.onclick=()=>exportSid(rec.id);
    const impBtn=document.createElement('button'); impBtn.textContent='Importera'; impBtn.style.marginLeft='6px'; impBtn.onclick=()=>{ const i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=(e)=>{ const f=e.target.files[0]; if(f) importSid(rec.id, f); }; i.click(); };
    const delBtn=document.createElement('button'); delBtn.textContent='Ta bort'; delBtn.style.marginLeft='6px'; delBtn.onclick=()=>deleteSid(rec.id);
    td3.appendChild(openBtn); td3.appendChild(renBtn); td3.appendChild(expBtn); td3.appendChild(impBtn); td3.appendChild(delBtn);
    tr.appendChild(td3);
    tbody.appendChild(tr);
  });
}

document.getElementById('starttid').value = new Date().toLocaleString();
document.getElementById('createBtn').onclick=()=>{
  const id=(document.getElementById('snummer').value||'').trim();
  if(!id){ alert('Fyll i Sändningsnummer.'); return; }
  const list=getList();
  if(list.some(x=>String(x.id)===id)){ alert('Det finns redan en sändning med detta nummer.'); return; }
  const rec={ id, starttid: new Date().toLocaleString(), createdAt: nowIso(), updatedAt: nowIso() };
  list.push(rec); setList(list);
  localStorage.setItem('inlev:ship:'+id+':insamlare:uppackning:rows', '[]');
  localStorage.setItem('inlev:ship:'+id+':insamlare:lankade:rows', '[]');
  localStorage.setItem('inlev:ship:'+id+':insamlare:registrerade:rows', '[]');
  localStorage.setItem('inlev:ship:'+id+':update:uppackning:rows', '[]');
  localStorage.setItem('inlev:ship:'+id+':update:registrerade:rows', '[]');
  location.href = '/overblick.html?sid='+encodeURIComponent(id);
};
renderList();
</script>
</body></html>
