<!doctype html><html lang="sv"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sändningar – Inleverans</title>
<link rel="stylesheet" href="/styles.css"/>
</head><body>
<script src="/auth.js"></script>
<script>try{ if(!InlevAuth.isAuthed||!InlevAuth.isAuthed()) location.href='/login.html'; }catch(e){ location.href='/login.html'; }</script>

    <div class="nav">
      <a href="/index.html">Hem</a>
      <a href="/sandningar.html">Sändningar</a>
      <a href="/insamlare.html">Basinformation<span id="flagBase" class="menu-dot"></span></a>
      <a href="/felsok.html">Felsök</a>
      <a href="/uppdatera-info.html">Uppdatera info</a>
      <a href="/skicka-diff.html">Skicka Diff</a>
      <div class="right">
        <span class="badge" id="who"></span>
        <button id="logoutBtn">Logga ut</button>
      </div>
    </div>
    <script>
      (function(){
        const w=document.getElementById('who');
        try{ if(InlevAuth.isAuthed()){ const s=InlevAuth.get(); w.textContent=(s?.user?.name||'')+' '+(s?.user?.role?'('+s.user.role+')':''); } }catch(e){}
        document.getElementById('logoutBtn').onclick=()=>{ InlevAuth.signOut(); location.href='/login.html'; };
      })();
    </script>
    
<div class="container">
<h1>Sändningar</h1>
<div class="card grid grid-2">
  <div>
    <label>Namn på ny sändning</label>
    <input id="newName" placeholder="Sändningsnummer eller valfritt namn"/>
    <div style="margin-top:8px"><button class="btn btn-green" id="createBtn">Skapa</button></div>
  </div>
  <div>
    <div class="small">Klicka på en rad för att öppna sändningen.</div>
    <div id="srv" class="small"></div>
  </div>
</div>
<div class="card">
  <table class="table">
    <thead><tr><th>Namn</th><th>Skapad</th><th></th></tr></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
</div>
<script src="/app.js"></script><script src="/api.js"></script>
<script>
// Visa meny-knappar endast när en sändning är aktiv
(function(){
  try{
    var cur = (window.InlevApp && InlevApp.current && InlevApp.current()) || null;
    var links = [
      '/insamlare.html',
      '/felsok.html',
      '/uppdatera-info.html',
      '/skicka-diff.html'
    ];
    links.forEach(function(href){
      var a = Array.from(document.querySelectorAll('a')).find(x=>x.getAttribute('href')===href);
      if(a && !cur){ a.style.display='none'; }
    });
  }catch(e){ /* ignore */ }
})();
</script>

<script>
(async function(){
  const tbody=document.getElementById('tbody');
  const dot=document.getElementById('srv');
  all[id].meta.number=nn; localStorage.setItem('inleverans_shipments_v1', JSON.stringify(all)); } renderShip(); });
    tbody.querySelectorAll('button[data-exp]').forEach(b=>b.onclick=()=>{ const data=InlevApp.get(b.dataset.exp); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(data?.meta?.number||b.dataset.exp)+'.json'; a.click(); });
    tbody.querySelectorAll('button[data-imp]').forEach(b=>b.onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=()=>{ const f=inp.files[0]; const fr=new FileReader(); fr.onload=()=>{ try{ const json=JSON.parse(fr.result); const all=JSON.parse(localStorage.getItem('inleverans_shipments_v1')||'{}'); all[b.dataset.imp]=json; localStorage.setItem('inleverans_shipments_v1', JSON.stringify(all)); alert('Importerad'); renderShip(); }catch(e){ alert('Ogiltig fil'); } }; fr.readAsText(f); }; inp.click(); });
  }
  renderShip();
})();
</script>

<script>
(function(){
  function go(){
    try{
      var input = document.getElementById('newName');
      var name = (input && input.value ? input.value.trim() : '') || ('Sändning ' + Date.now());
      if(window.InlevApp && InlevApp.create && InlevApp.setCurrent){
        var id = InlevApp.create(name);
        InlevApp.setCurrent(id);
      }
      setTimeout(function(){ window.location.href='/insamlare.html'; }, 50);
    }catch(e){
      console.error('Skapa-fel:', e);
      // Sista nödlösning: lägg ett id i localStorage och gå vidare
      try{
        var id = Date.now() + '-' + Math.random().toString(36).slice(2,8);
        localStorage.setItem('inleverans_current', id);
        var all = JSON.parse(localStorage.getItem('inleverans_shipments_v1')||'{}');
        all[id] = all[id] || {meta:{number:name, createdAt:new Date().toISOString()}, data:{}};
        localStorage.setItem('inleverans_shipments_v1', JSON.stringify(all));
      }catch(e2){}
      setTimeout(function(){ window.location.href='/insamlare.html'; }, 50);
    }
  }
  var btn = document.getElementById('createBtn');
  if(btn){ btn.addEventListener('click', function(ev){ ev.preventDefault(); go(); }); }
  var inp = document.getElementById('newName');
  if(inp){ inp.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); go(); } }); }
})();
</script>
</body></html>