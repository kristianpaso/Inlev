(function(){const K='auth_enf_'+location.host,DAY=864e5,POST='postLogin',ONCE='authOnce';const L=()=>{try{return JSON.parse(localStorage.getItem(K)||'null')}catch(e){return null}};const S=t=>localStorage.setItem(K,JSON.stringify(t));const C=()=>localStorage.removeItem(K);function A(){const t=L();if(!t)return!1;if(!t.exp||Date.now()>t.exp){C();return!1}return!0}function U(){const t=L();return t&&t.user||null}async function T(u,p){try{const r=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({username:u,password:p})});if(r.ok)return{user:u,exp:Date.now()+DAY,issued:Date.now()}}catch(e){}return null}async function login(u,p){let t=await T(u,p);if(!t){if(!u)throw new Error('Skriv ett anvÃ¤ndarnamn.');t={user:u,exp:Date.now()+DAY,issued:Date.now()}}S(t);return!0}function logout(){C()}function remember(){try{sessionStorage.setItem(POST,location.pathname+location.search+location.hash)}catch(e){}}function consume(){try{const v=sessionStorage.getItem(POST);sessionStorage.removeItem(POST);return v||'/statistik/'}catch(e){return'/statistik/'}}function guard(){const dirs=['/plock','/trav','/statistik','/schema','/sandningar','/sandningar'];const p=location.pathname;const needs=dirs.some(d=>p===d||p.startsWith(d+'/'));if(needs&&!A()){if(!sessionStorage.getItem(ONCE)){sessionStorage.setItem(ONCE,'1');remember();location.replace('/login.html')}}}window.InlevAuth={login,logout,isAuthed:A,guard,getUser:U};try{guard()}catch(e){}if(A()&&location.pathname.toLowerCase().endsWith('/login.html'))location.replace(consume())})();