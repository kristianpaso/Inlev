<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inlev – Admin</title>
<link rel="icon" href="data:,">
<script src="/auth.js" defer></script>
<style>
:root{ --bg:#0a0f24; --panel:#0f1a44; --text:#e7eeff; --border:#1e2a57; --ok:#2ea043; --warn:#c48b07; --err:#cc4a4a; }
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#0a0f24,#0a0c16);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,'Helvetica Neue',Arial,sans-serif}
.nav{position:sticky;top:0;z-index:50;display:flex;gap:10px;align-items:center;background:#0b1020cc;border-bottom:1px solid #1e2a57;padding:10px 16px;backdrop-filter:blur(6px)}
.badge,a.btn,button.btn{background:#0f1a44;border:1px solid #1e2a57;border-radius:999px;padding:8px 12px;color:#e7eeff;text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer}
.container{max-width:1100px;margin:0 auto;padding:16px}
h1{margin:12px 0 10px}
.grid{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}
.card{background:#0b1330;border:1px solid #1e2a57;border-radius:14px;padding:16px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px 12px;border-bottom:1px solid #1e2a57;text-align:left}
.table th{position:sticky;top:56px;background:#0c1230;z-index:2}
.table .num{text-align:right}
.input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1e2a57;background:#0b1434;color:#e7eeff}
.row{display:flex;gap:10px;flex-wrap:wrap}
.right{margin-left:auto}
.status{opacity:.8}
.k{font-weight:700;opacity:.8}
.ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
</style>
</head>
<body>
<div class="nav">
  <a href="/" class="btn">Startsidan</a>
  <a href="/sandningar.html" class="btn">Sändning</a>
  <span class="right status" id="status">Admin-panel</span>
</div>

<div class="container">
  <h1>Användare & Roller</h1>
  <div class="grid">
    <div class="card">
      <table class="table" id="tbl"></table>
      <div id="empty" class="status"></div>
    </div>
    <div class="card">
      <h3>Ny användare</h3>
      <div class="row"><input id="email" class="input" placeholder="E-post"></div>
      <div class="row"><input id="password" class="input" placeholder="Lösenord" type="password"></div>
      <div class="row">
        <select id="role">
          <option value="watcher">Watcher</option>
          <option value="superuser">Superuser</option>
          <option value="admin">Admin</option>
        </select>
      </div>
      <div class="row"><button class="btn" id="create">Skapa användare</button></div>
      <div class="status" id="msg"></div>
    </div>
  </div>
</div>

<script>
const HEAD=['E-post','Roll','Skapad','Åtgärder'];

async function api(path, opts={}){
  const res = await fetch(path, Object.assign({ credentials:'include' }, opts));
  const ct = res.headers.get('content-type')||'';
  if(res.status===204) return null;
  if(!ct.includes('application/json')) throw new Error('Bad response');
  const data = await res.json();
  if(!res.ok) throw new Error(data.error||('HTTP '+res.status));
  return data;
}

async function listUsers(){
  const d = await api('/api/auth/users');
  return d.users || [];
}

function render(users){
  const tbl=document.getElementById('tbl'); tbl.innerHTML='';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  HEAD.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
  thead.appendChild(trh); tbl.appendChild(thead);
  const tbody=document.createElement('tbody'); tbl.appendChild(tbody);
  let shown=0;
  users.forEach(u=>{
    const tr=document.createElement('tr');
    const created = (u.createdAt||'').replace('T',' ').replace('Z','');
    const sel=document.createElement('select');
    ['watcher','superuser','admin'].forEach(r=>{
      const o=document.createElement('option'); o.value=r; o.textContent=r;
      if(String(u.role).toLowerCase()===r) o.selected=true;
      sel.appendChild(o);
    });
    const btnSave=document.createElement('button'); btnSave.className='btn'; btnSave.textContent='Spara roll';
    btnSave.onclick = async()=>{
      btnSave.disabled=true;
      try{
        await ensureCsrf();
        await api('/api/auth/users/'+encodeURIComponent(u.id), {
          method:'PATCH',
          headers:{'Content-Type':'application/json','X-CSRF-Token': window._csrfToken},
          body: JSON.stringify({ role: sel.value })
        });
        setStatus('Roll uppdaterad.', 'ok');
      }catch(ex){ setStatus(ex.message, 'err'); } finally { btnSave.disabled=false; }
    };
    const pwd=document.createElement('input'); pwd.type='password'; pwd.placeholder='Nytt lösenord'; pwd.className='input';
    const btnPwd=document.createElement('button'); btnPwd.className='btn'; btnPwd.textContent='Byt lösenord';
    btnPwd.onclick = async()=>{
      const v=pwd.value.trim(); if(!v) return;
      btnPwd.disabled=true;
      try{
        await ensureCsrf();
        await api('/api/auth/users/'+encodeURIComponent(u.id), {
          method:'PATCH',
          headers:{'Content-Type':'application/json','X-CSRF-Token': window._csrfToken},
          body: JSON.stringify({ password: v })
        });
        pwd.value='';
        setStatus('Lösenord uppdaterat (sessioner ogiltigförklarade).', 'ok');
      }catch(ex){ setStatus(ex.message, 'err'); } finally { btnPwd.disabled=false; }
    };
    const btnDel=document.createElement('button'); btnDel.className='btn'; btnDel.textContent='Ta bort';
    btnDel.onclick=async()=>{
      if(!confirm('Ta bort användare '+u.email+'?')) return;
      btnDel.disabled=true;
      try{
        await ensureCsrf();
        await api('/api/auth/users/'+encodeURIComponent(u.id), {
          method:'DELETE',
          headers:{'X-CSRF-Token': window._csrfToken}
        });
        load();
      }catch(ex){ setStatus(ex.message, 'err'); } finally { btnDel.disabled=false; }
    };
    const c1=document.createElement('td'); c1.textContent=u.email;
    const c2=document.createElement('td'); c2.appendChild(sel);
    const c3=document.createElement('td'); c3.textContent=created;
    const c4=document.createElement('td'); c4.appendChild(btnSave); c4.appendChild(document.createTextNode(' ')); c4.appendChild(pwd); c4.appendChild(document.createTextNode(' ')); c4.appendChild(btnPwd); c4.appendChild(document.createTextNode(' ')); c4.appendChild(btnDel);
    tr.appendChild(c1);tr.appendChild(c2);tr.appendChild(c3);tr.appendChild(c4);
    tbody.appendChild(tr); shown++;
  });
  document.getElementById('empty').textContent = shown? '' : 'Inga användare.';
}

function setStatus(msg, cls){
  const el=document.getElementById('status'); el.textContent=msg; el.className='status '+(cls||'');
}

async function ensureCsrf(){
  if(window._csrfToken) return window._csrfToken;
  const res = await api('/api/auth/csrf');
  window._csrfToken = res.token;
  return window._csrfToken;
}

async function load(){
  try{
    // require admin
    if(!window.InlevAuth){ throw new Error('Auth init saknas'); }
    const me = await InlevAuth.me();
    if(!me){ location.href='/login.html?return='+encodeURIComponent(location.pathname); return; }
    if(String(me.role).toLowerCase()!=='admin'){
      document.documentElement.innerHTML='<div style="padding:24px;color:#e7eeff;background:#0b1020;font-family:sans-serif">Endast admin.</div>';
      return;
    }
    const users = await listUsers();
    render(users);
    setStatus('Admin – '+users.length+' användare', 'ok');
  }catch(ex){
    setStatus(ex.message||String(ex), 'err');
  }
}

window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('create').addEventListener('click', async ()=>{
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    if(!email || !password) return setStatus('Fyll i e-post och lösenord', 'warn');
    try{
      await ensureCsrf();
      await api('/api/auth/users', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRF-Token': window._csrfToken},
        body: JSON.stringify({ email, password, role })
      });
      document.getElementById('email').value='';
      document.getElementById('password').value='';
      document.getElementById('role').value='watcher';
      setStatus('Användare skapad', 'ok'); load();
    }catch(ex){ setStatus(ex.message, 'err'); }
  });
  load();
});
</script>
</body>
</html>
